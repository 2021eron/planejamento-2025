<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejamento 2024-2030 (Online)</title>
    <!-- ESTILOS (CSS) -->
    <style>
        :root {
            --cor-fundo: #0b1a33; 
            --cor-principal: #1e3a6b; 
            --cor-destaque: #3b5998;
            --cor-texto: #dfe3ee; 
            --cor-rosa-fds: #fce4e4; 
            --cor-texto-erro: #ffcdd2;
            
            /* Cores Vibrantes ATUALIZADAS */
            --cor-verde: #8BC34A;
            --cor-amarelo: #FFEE58; 
            --cor-laranja: #FFA726; 
            --cor-vermelho: #EF5350; 
            --cor-roxo: #9575CD; 
        }

        body { font-family: system-ui, sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); margin: 0; padding: 0; }
        .hidden { display: none !important; }

        /* ===== ESTILOS DA TELA DE LOGIN ===== */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--cor-fundo); display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .login-box {
            background-color: var(--cor-principal); padding: 40px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 100%; max-width: 380px; text-align: center;
        }
        .login-box h2 { margin-top: 0; margin-bottom: 25px; font-size: 1.8em; }
        .login-box .input-group { margin-bottom: 20px; text-align: left; }
        .login-box label { display: block; margin-bottom: 5px; font-weight: bold; }
        .login-box input {
            width: 100%; padding: 12px; border-radius: 5px; border: 1px solid var(--cor-texto);
            font-size: 1em; box-sizing: border-box; background-color: var(--cor-fundo); color: var(--cor-texto);
        }
        .login-box button {
            width: 100%; padding: 12px; border-radius: 5px; border: none; font-size: 1.1em;
            font-weight: bold; cursor: pointer; background-color: var(--cor-destaque); color: white; transition: background-color 0.2s;
        }
        .login-box button:hover { opacity: 0.9; }
        #login-error { color: var(--cor-texto-erro); margin-top: 15px; font-weight: bold; height: 20px; }

        /* ===== ESTILOS DO APP PRINCIPAL ===== */
        #app-container { padding: 15px; }
        .container { max-width: 1400px; margin: auto; }
        header { text-align: center; margin-bottom: 20px; }
        .title-container { 
            display: flex; justify-content: center; align-items: center; 
            gap: 20px; flex-wrap: wrap; 
        }
        .title { background-color: var(--cor-destaque); padding: 10px 20px; font-size: 2em; font-weight: bold; display: inline-block; border-radius: 8px; border: 2px solid var(--cor-texto); }
        .year-selector-group { display: flex; align-items: center; gap: 10px; }
        #year-select {
            padding: 10px; font-size: 1.2em; font-weight: bold; background-color: var(--cor-fundo); color: var(--cor-texto);
            border: 2px solid var(--cor-texto); border-radius: 8px; cursor: pointer;
        }
        .user-actions { display: flex; gap: 10px; order: 3; }
        .user-actions button {
            background-color: var(--cor-vermelho); color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        .user-actions #change-password-btn { background-color: var(--cor-destaque); }
        
        /* Legendas ATUALIZADAS */
        .legend { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
        .legend-item { padding: 8px 15px; border-radius: 5px; font-weight: bold; font-size: 0.9em; border: 2px solid; }
        .legend-verde { background-color: var(--cor-principal); color: var(--cor-verde); border-color: var(--cor-verde); }
        .legend-laranja { background-color: var(--cor-principal); color: var(--cor-laranja); border-color: var(--cor-laranja); }
        .legend-amarelo { background-color: var(--cor-principal); color: var(--cor-amarelo); border-color: var(--cor-amarelo); }
        .legend-vermelho { background-color: var(--cor-principal); color: var(--cor-vermelho); border-color: var(--cor-vermelho); }
        .legend-roxo { background-color: var(--cor-principal); color: var(--cor-roxo); border-color: var(--cor-roxo); }
        
        .controls-container {
            display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 25px;
            padding: 20px; background-color: var(--cor-principal); border-radius: 8px; flex-wrap: wrap;
        }
        .employee-controls { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; flex: 1; min-width: 280px; }
        .employee-controls select:disabled, .employee-controls input:disabled, .employee-controls button:disabled { background-color: #555 !important; cursor: not-allowed !important; opacity: 0.6; }
        .employee-controls select, .employee-controls input, .employee-controls button { padding: 10px; border-radius: 5px; border: 1px solid var(--cor-texto); font-size: 1em; width: 100%; max-width: 400px; box-sizing: border-box; }
        .employee-controls button { cursor: pointer; background-color: var(--cor-destaque); color: white; font-weight: bold; }
        #new-employee-email { margin-top: 5px; }
        
        .summary-container { flex: 1; min-width: 280px; padding: 15px; background-color: var(--cor-destaque); border-radius: 8px; display: flex; flex-direction: column; gap: 8px; }
        .summary-item { font-size: 1em; display: flex; justify-content: space-between; align-items: center; }
        .summary-item strong { font-size: 1.1em; }
        .summary-item span { font-weight: bold; background-color: var(--cor-fundo); padding: 2px 8px; border-radius: 4px; min-width: 40px; text-align: center; }
        .summary-total { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--cor-texto); }
        .saldo-positivo { color: var(--cor-verde) !important; }
        .saldo-negativo { color: var(--cor-vermelho) !important; }
        
        #view-only-notice {
            text-align: center; font-weight: bold; color: var(--cor-amarelo);
            background-color: var(--cor-principal); padding: 10px; border-radius: 8px; margin-bottom: 20px;
        }

        #calendar-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .month-container { flex: 1 1 300px; min-width: 300px; max-width: 400px; }
        .month-title { text-align: center; font-size: 1.2em; font-weight: bold; color: var(--cor-texto); margin-bottom: 10px; }
        .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .header-cell, .day-cell { display: flex; align-items: center; justify-content: center; padding: 5px; border-radius: 4px; }
        .header-cell { background-color: var(--cor-principal); font-weight: bold; font-size: 0.8em; }
        
        .day-cell { background-color: white; color: black; font-size: 0.9em; height: 35px; position: relative; }
        .day-cell.weekend { background-color: var(--cor-rosa-fds); }
        .day-cell.valid-day { cursor: pointer; }
        .day-cell.empty { background-color: transparent; cursor: default; }

        /* Cores de célula ATUALIZADAS */
        .day-cell.color-verde { background-color: var(--cor-verde); color: var(--cor-fundo); font-weight: bold; }
        .day-cell.color-laranja { background-color: var(--cor-laranja); color: var(--cor-fundo); font-weight: bold; }
        .day-cell.color-amarelo { background-color: var(--cor-amarelo); color: var(--cor-fundo); font-weight: bold; }
        .day-cell.color-vermelho { background-color: var(--cor-vermelho); color: white; font-weight: bold; }
        .day-cell.color-roxo { background-color: var(--cor-roxo); color: white; font-weight: bold; }

        .day-cell.has-hours::after {
            content: ''; position: absolute; top: 3px; right: 3px;
            width: 6px; height: 6px; background-color: #0b1a33; border-radius: 50%;
        }

        /* ===== ESTILOS DOS MODAIS ===== */
        #day-editor-modal, #change-password-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--cor-principal); padding: 25px; border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); width: 90%; max-width: 450px;
            border: 2px solid var(--cor-destaque);
        }
        .modal-content h3 { margin-top: 0; font-size: 1.5em; text-align: center; margin-bottom: 25px; }
        .modal-input-group { margin-bottom: 15px; }
        .modal-input-group label { display: block; font-weight: bold; margin-bottom: 8px; }
        .modal-input-group select, .modal-input-group input {
            width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--cor-texto);
            font-size: 1em; box-sizing: border-box; background-color: var(--cor-fundo); color: var(--cor-texto);
        }
        
        .modal-input-group input:disabled, .modal-input-group select:disabled {
            background-color: #2a4a7b !important;
            color: var(--cor-texto) !important;
            opacity: 1 !important;
            cursor: not-allowed;
        }

        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }
        .modal-buttons button {
            padding: 10px 20px; border-radius: 5px; border: none; font-size: 1em;
            font-weight: bold; cursor: pointer; transition: opacity 0.2s;
        }
        .modal-buttons button:hover { opacity: 0.9; }
        #modal-save-btn, #password-save-btn { background-color: var(--cor-destaque); color: white; }
        #modal-cancel-btn, #password-cancel-btn { background-color: #6c757d; color: white; }
        
        /* NOVO: Estilo para inputs lado a lado no modal */
        .input-row { display: flex; gap: 10px; }
        .input-row .input-item { display: flex; flex-direction: column; flex-grow: 1; }
        .input-row .input-item:first-child { flex-basis: 35%; }
        .input-row .input-item:last-child { flex-basis: 65%; }

        /* NOVO: Estilos do Tooltip */
        #day-tooltip {
            position: absolute; z-index: 3000; background-color: #2c3e50; color: white;
            border: 1px solid #769fcd; border-radius: 8px; padding: 12px; font-size: 0.95em;
            width: 250px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: none; /* Impede que o tooltip interfira com o mouse */
            transition: opacity 0.1s ease-in-out;
        }
        #day-tooltip h4 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; color: var(--cor-amarelo); border-bottom: 1px solid #4a6582; padding-bottom: 8px; }
        #day-tooltip p { margin: 6px 0; display: flex; justify-content: space-between; align-items: center;}
        #day-tooltip p span { color: #bdc3c7; }
        #day-tooltip .obs { font-style: italic; color: #bdc3c7; background-color: #34495e; padding: 4px 8px; border-radius: 4px; margin-top: 4px; justify-content: flex-start; width: 100%; box-sizing: border-box;}

    </style>
</head>
<body>

    <!-- TELA DE LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2>Acessar Planejamento</h2>
            <form id="login-form">
                <div class="input-group"><label for="username">E-mail</label><input type="email" id="username" required></div>
                <div class="input-group"><label for="password">Senha</label><input type="password" id="password" required></div>
                <button type="submit">Entrar</button><p id="login-error"></p>
            </form>
        </div>
    </div>
    
    <!-- APLICAÇÃO PRINCIPAL -->
    <div id="app-container" class="hidden">
        <div class="container">
            <header>
                <div class="title-container">
                    <div class="title">PLANEJAMENTO</div>
                    <div class="year-selector-group">
                        <label for="year-select" style="font-size: 1.2em; font-weight: bold;">Ano:</label>
                        <select id="year-select">
                            <option value="2024">2024</option><option value="2025" selected>2025</option><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option><option value="2030">2030</option>
                        </select>
                    </div>
                    <div class="user-actions">
                        <button id="change-password-btn">Alterar Senha</button>
                        <button id="logout-btn">Sair</button>
                    </div>
                </div>
                <div class="legend">
                    <div class="legend-item legend-verde">Feriados Nacionais</div>
                    <div class="legend-item legend-laranja">Feriados Estaduais</div>
                    <div class="legend-item legend-amarelo">Emendas</div>
                    <div class="legend-item legend-vermelho">Faltas</div>
                    <div class="legend-item legend-roxo">Afastado</div>
                </div>
            </header>
            
            <div id="view-only-notice" class="hidden">Você está no modo de visualização. As edições estão desativadas.</div>

            <div class="controls-container">
                <!-- SEÇÃO ATUALIZADA COM O BOTÃO DE SUPERVISOR -->
                <div class="employee-controls">
                    <label for="employee-select">Funcionário: <span id="employee-status" style="font-weight:normal; font-style:italic;"></span></label>
                    <select id="employee-select"></select>
                    <input type="text" id="new-employee-name" placeholder="Nome do novo funcionário">
                    <input type="email" id="new-employee-email" placeholder="E-mail de login do funcionário (opcional)">
                    <button id="add-employee-btn">Adicionar</button>
                    <button id="remove-employee-btn">Remover Selecionado</button>
                    <button id="make-supervisor-btn" class="hidden" style="background-color: var(--cor-amarelo); color: var(--cor-fundo);">Tornar/Remover Supervisor</button>
                </div>
                <div class="summary-container">
                    <div class="summary-item"> Folgas Úteis: <span id="summary-uteis">0</span> </div>
                    <div class="summary-item"> Folgas Feriado e FDS: <span id="summary-feriado-fds">0</span> </div>
                    <div class="summary-item summary-total"> <strong>TOTAL FOLGAS:</strong> <strong><span id="summary-total">0</span></strong> </div>
                    <div class="summary-item summary-total"> Horas Extras (Ano): <span id="summary-extras">0</span> </div>
                    <div class="summary-item"> Horas Atraso (Ano): <span id="summary-atrasos">0</span> </div>
                    <div class="summary-item summary-total"> <strong>SALDO DE HORAS:</strong> <strong><span id="summary-saldo">0</span></strong> </div>
                </div>
            </div>
            
            <div id="calendar-container"></div>
        </div>
    </div>

    <!-- MODAL PARA EDITAR O DIA (Estrutura ATUALIZADA) -->
    <div id="day-editor-modal" class="hidden">
        <div class="modal-content">
            <h3 id="modal-title">Editar Dia</h3>
            <div class="modal-input-group">
                <label for="modal-color-select">Status do Dia</label>
                <select id="modal-color-select">
                    <option value="default">Dia Normal</option>
                    <option value="verde">Feriado Nacional</option>
                    <option value="amarelo">Emenda</option>
                    <option value="laranja">Feriado Estadual</option>
                    <option value="vermelho">Falta</option>
                    <option value="roxo">Afastado</option>
                </select>
            </div>
            <div class="modal-input-group">
                <div class="input-row">
                    <div class="input-item">
                        <label for="modal-extra-hours">Horas Extras</label>
                        <input type="number" id="modal-extra-hours" list="hours-datalist" min="0" step="0.25" placeholder="Ex: 2.5">
                    </div>
                    <div class="input-item">
                        <label for="modal-extra-obs">Observação</label>
                        <input type="text" id="modal-extra-obs" placeholder="Pequena anotação">
                    </div>
                </div>
            </div>
            <div class="modal-input-group">
                 <div class="input-row">
                    <div class="input-item">
                        <label for="modal-late-hours">Horas de Atraso</label>
                        <input type="number" id="modal-late-hours" list="hours-datalist" min="0" step="0.25" placeholder="Ex: 0.5">
                    </div>
                    <div class="input-item">
                        <label for="modal-late-obs">Observação</label>
                        <input type="text" id="modal-late-obs" placeholder="Pequena anotação">
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="modal-cancel-btn">Cancelar</button>
                <button id="modal-save-btn">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PARA ALTERAR A SENHA -->
    <div id="change-password-modal" class="hidden">
        <div class="modal-content">
            <h3>Alterar Senha</h3>
            <div class="modal-input-group">
                <label for="new-password">Nova Senha</label>
                <input type="password" id="new-password" placeholder="Mínimo de 6 caracteres" required>
            </div>
             <div class="modal-input-group">
                <label for="confirm-password">Confirmar Nova Senha</label>
                <input type="password" id="confirm-password" required>
            </div>
            <p id="password-change-error" style="color: var(--cor-texto-erro); height: 20px; font-weight:bold;"></p>
            <div class="modal-buttons">
                <button id="password-cancel-btn">Cancelar</button>
                <button id="password-save-btn">Salvar Nova Senha</button>
            </div>
        </div>
    </div>

    <!-- NOVO: Elemento do Tooltip -->
    <div id="day-tooltip" class="hidden"></div>

    <datalist id="hours-datalist"></datalist>

    <!-- SCRIPTS DO FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- SCRIPT PRINCIPAL ATUALIZADO -->
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBVAUP4agCEN6pVXWXOsQDG7Bzfile2OWU",
          authDomain: "planejamento-lofty-4029e.firebaseapp.com",
          projectId: "planejamento-lofty-4029e",
          storageBucket: "planejamento-lofty-4029e.firebasestorage.app",
          messagingSenderId: "281028453977",
          appId: "1:281028453977:web:79401f37adcbef469eb348"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let docRef; 

        document.addEventListener('DOMContentLoaded', () => {
            const auth = firebase.auth();
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');

            function showApp(userRole, userEmail) {
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initializeAppLogic(userRole, userEmail);
            }

            function showLogin() {
                appContainer.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                if (typeof stopListeningToFirebase === 'function') {
                    stopListeningToFirebase();
                }
            }
            
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                loginError.textContent = '';
                auth.signInWithEmailAndPassword(email, password)
                    .catch((error) => {
                        loginError.textContent = 'E-mail ou senha inválidos.';
                        document.getElementById('password').value = '';
                    });
            });

            logoutBtn.addEventListener('click', () => { auth.signOut().then(() => { location.reload(); }); });

            // LÓGICA DE AUTENTICAÇÃO ATUALIZADA PARA TRÊS FUNÇÕES
            auth.onAuthStateChanged(user => {
                if (user) {
                    const userRoleRef = db.collection("user_roles").doc(user.uid);
                    userRoleRef.get().then((doc) => {
                        let role = 'viewer'; // Padrão é visualizador
                        if (doc.exists && doc.data().role) {
                            // As funções podem ser 'editor', 'supervisor', ou 'viewer'
                            role = doc.data().role;
                        }
                        showApp(role, user.email); 
                    }).catch((error) => {
                        console.error("Erro ao buscar função do usuário:", error);
                        showApp('viewer', user.email); // Em caso de erro, assume a função mais restrita
                    });
                } else {
                    showLogin();
                }
            });
            
            let stopListeningToFirebase = null; 

            function initializeAppLogic(userRole, userEmail) {
                // NOVA LÓGICA DE PERMISSÕES
                const canEdit = userRole === 'editor';
                const canViewAll = userRole === 'editor' || userRole === 'supervisor';
                
                const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

                const NATIONAL_HOLIDAYS = {
                    2024: { '2024-01-01':{c:'v'},'2024-02-12':{c:'v'},'2024-02-13':{c:'v'},'2024-03-29':{c:'v'},'2024-04-21':{c:'v'},'2024-05-01':{c:'v'},'2024-05-30':{c:'v'},'2024-09-07':{c:'v'},'2024-10-12':{c:'v'},'2024-11-02':{c:'v'},'2024-11-15':{c:'v'},'2024-11-20':{c:'v'},'2024-12-25':{c:'v'} },
                    2025: { '2025-01-01':{c:'v'},'2025-03-03':{c:'v'},'2025-03-04':{c:'v'},'2025-04-18':{c:'v'},'2025-04-21':{c:'v'},'2025-05-01':{c:'v'},'2025-06-19':{c:'v'},'2025-09-07':{c:'v'},'2025-10-12':{c:'v'},'2025-11-02':{c:'v'},'2025-11-15':{c:'v'},'2025-11-20':{c:'v'},'2025-12-25':{c:'v'} },
                    2026: { '2026-01-01':{c:'v'},'2026-02-16':{c:'v'},'2026-02-17':{c:'v'},'2026-04-03':{c:'v'},'2026-04-21':{c:'v'},'2026-05-01':{c:'v'},'2026-06-04':{c:'v'},'2026-09-07':{c:'v'},'2026-10-12':{c:'v'},'2026-11-02':{c:'v'},'2026-11-15':{c:'v'},'2026-12-25':{c:'v'} },
                    2027: { '2027-01-01':{c:'v'},'2027-02-08':{c:'v'},'2027-02-09':{c:'v'},'2027-03-26':{c:'v'},'2027-04-21':{c:'v'},'2027-05-01':{c:'v'},'2027-05-27':{c:'v'},'2027-09-07':{c:'v'},'2027-10-12':{c:'v'},'2027-11-02':{c:'v'},'2027-11-15':{c:'v'},'2027-12-25':{c:'v'} },
                    2028: { '2028-01-01':{c:'v'},'2028-02-28':{c:'v'},'2028-02-29':{c:'v'},'2028-04-14':{c:'v'},'2028-04-21':{c:'v'},'2028-05-01':{c:'v'},'2028-06-15':{c:'v'},'2028-09-07':{c:'v'},'2028-10-12':{c:'v'},'2028-11-02':{c:'v'},'2028-11-15':{c:'v'},'2028-11-20':{c:'v'},'2028-12-25':{c:'v'} },
                    2029: { '2029-01-01':{c:'v'},'2029-02-12':{c:'v'},'2029-02-13':{c:'v'},'2029-03-30':{c:'v'},'2029-04-21':{c:'v'},'2029-05-01':{c:'v'},'2029-05-31':{c:'v'},'2029-09-07':{c:'v'},'2029-10-12':{c:'v'},'2029-11-02':{c:'v'},'2029-11-15':{c:'v'},'2029-12-25':{c:'v'} },
                    2030: { '2030-01-01':{c:'v'},'2030-03-04':{c:'v'},'2030-03-05':{c:'v'},'2030-04-19':{c:'v'},'2030-04-21':{c:'v'},'2030-05-01':{c:'v'},'2030-06-20':{c:'v'},'2030-09-07':{c:'v'},'2030-10-12':{c:'v'},'2030-11-02':{c:'v'},'2030-11-15':{c:'v'},'2030-12-25':{c:'v'} }
                };
                
                const yearSelect = document.getElementById('year-select');
                let selectedYear = parseInt(yearSelect.value);

                const MONTHS = ['JANEIRO', 'FEVEREIRO', 'MARÇO', 'ABRIL', 'MAIO', 'JUNHO', 'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'];
                const DAYS_OF_WEEK = ['SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SÁB', 'DOM'];
                
                const calendarContainer = document.getElementById('calendar-container');
                const employeeSelect = document.getElementById('employee-select');
                const newEmployeeInput = document.getElementById('new-employee-name');
                const newEmployeeEmailInput = document.getElementById('new-employee-email');
                const addEmployeeBtn = document.getElementById('add-employee-btn');
                const removeEmployeeBtn = document.getElementById('remove-employee-btn');
                const makeSupervisorBtn = document.getElementById('make-supervisor-btn');
                const employeeStatusSpan = document.getElementById('employee-status');
                
                const modal = document.getElementById('day-editor-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalColorSelect = document.getElementById('modal-color-select');
                const modalExtraHours = document.getElementById('modal-extra-hours');
                const modalLateHours = document.getElementById('modal-late-hours');
                const modalSaveBtn = document.getElementById('modal-save-btn');
                const modalCancelBtn = document.getElementById('modal-cancel-btn');
                const modalExtraObs = document.getElementById('modal-extra-obs');
                const modalLateObs = document.getElementById('modal-late-obs');
                let currentlyEditingDate = null;

                const tooltip = document.getElementById('day-tooltip');
                let activeTooltipCell = null; 
                
                const changePasswordBtn = document.getElementById('change-password-btn');
                const changePasswordModal = document.getElementById('change-password-modal');
                const newPasswordInput = document.getElementById('new-password');
                const confirmPasswordInput = document.getElementById('confirm-password');
                const passwordSaveBtn = document.getElementById('password-save-btn');
                const passwordCancelBtn = document.getElementById('password-cancel-btn');
                const passwordChangeError = document.getElementById('password-change-error');

                let state = { funcionarios: [], funcionarioSelecionadoId: null };
                let localStateLoaded = false;
                
                function populateHoursDatalist() {
                    const datalist = document.getElementById('hours-datalist');
                    if (datalist.options.length > 0) return; 
                    const options = [];
                    for (let min = 5; min <= 55; min += 5) { options.push({ label: `${min} min`, value: (min / 60).toFixed(4) }); }
                    for (let h = 1; h <= 8; h++) {
                        options.push({ label: `${h} hora${h > 1 ? 's' : ''}`, value: h });
                        options.push({ label: `${h}h 30 min`, value: h + 0.5 });
                    }
                    options.forEach(opt => {
                        const optionEl = document.createElement('option');
                        optionEl.value = opt.value;
                        optionEl.label = opt.label;
                        datalist.appendChild(optionEl);
                    });
                }
                
                function setupUIForRole() {
                    newEmployeeInput.disabled = !canEdit;
                    newEmployeeEmailInput.disabled = !canEdit;
                    addEmployeeBtn.disabled = !canEdit;
                    removeEmployeeBtn.disabled = !canEdit;
                    employeeSelect.disabled = !canViewAll;
                    yearSelect.disabled = false; 

                    makeSupervisorBtn.classList.toggle('hidden', !canEdit);
                    
                    const viewOnlyNotice = document.getElementById('view-only-notice');
                    viewOnlyNotice.classList.toggle('hidden', canEdit);
                }

                function saveState() {
                    if (!localStateLoaded || !canEdit || !docRef) return;
                    docRef.set(state).catch(error => console.error("Erro ao salvar no Firebase: ", error));
                }

                function listenForChanges() {
                    if (stopListeningToFirebase) { stopListeningToFirebase(); }
                    selectedYear = parseInt(yearSelect.value);
                    docRef = db.collection("planejamentos").doc(`dados${selectedYear}`);
                    stopListeningToFirebase = docRef.onSnapshot(doc => {
                        if (doc.exists) { state = doc.data(); } 
                        else {
                            if (canEdit) {
                                const initialId = `func-${Date.now()}`;
                                const holidaysForYear = NATIONAL_HOLIDAYS[selectedYear] || {};
                                const initialCalendar = {};
                                for (const date in holidaysForYear) { initialCalendar[date] = { cor: 'verde' }; }
                                state = {
                                    funcionarios: [{ id: initialId, nome: "Meu Planejamento", email: userEmail, calendario: initialCalendar }],
                                    funcionarioSelecionadoId: initialId,
                                };
                                saveState();
                            } else { state = { funcionarios: [], funcionarioSelecionadoId: null }; }
                        }
                        localStateLoaded = true;
                        renderApp();
                    });
                }
                
                function calculateAndDisplaySummaries() {
                    const funcionarioAtual = state.funcionarios.find(f => f.id === state.funcionarioSelecionadoId);
                    let folgasUteis = 0, folgasFeriadoFDS = 0, totalExtras = 0, totalAtrasos = 0;
                    if (funcionarioAtual && funcionarioAtual.calendario) {
                        for (const dateString in funcionarioAtual.calendario) {
                            const entry = funcionarioAtual.calendario[dateString] || {};
                            const data = typeof entry === 'string' ? { cor: entry } : entry;
                            data.extras = parseFloat(data.extras) || 0;
                            data.atrasos = parseFloat(data.atrasos) || 0;
                            const date = new Date(dateString + 'T00:00:00');
                            const dayOfWeek = date.getDay(); 
                            const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
                            if (isWeekday && ['amarelo', 'laranja'].includes(data.cor)) { folgasUteis++; }
                            if (data.cor === 'verde' || (!isWeekday && ['amarelo', 'laranja', 'vermelho'].includes(data.cor))) { folgasFeriadoFDS++; }
                            totalExtras += data.extras;
                            totalAtrasos += data.atrasos;
                        }
                    }
                    const saldoHoras = totalExtras - totalAtrasos;
                    const saldoEl = document.getElementById('summary-saldo');
                    document.getElementById('summary-uteis').textContent = folgasUteis;
                    document.getElementById('summary-feriado-fds').textContent = folgasFeriadoFDS;
                    document.getElementById('summary-total').textContent = folgasUteis + folgasFeriadoFDS;
                    document.getElementById('summary-extras').textContent = totalExtras.toFixed(2);
                    document.getElementById('summary-atrasos').textContent = totalAtrasos.toFixed(2);
                    saldoEl.textContent = saldoHoras.toFixed(2);
                    saldoEl.className = ''; 
                    saldoEl.classList.add(saldoHoras > 0 ? 'saldo-positivo' : (saldoHoras < 0 ? 'saldo-negativo' : ''));
                }

                function renderApp() {
                    setupUIForRole(); 
                    renderEmployeeControls();
                    renderCalendar();
                    calculateAndDisplaySummaries();
                }

                function renderEmployeeControls() {
                    employeeSelect.innerHTML = '';
                    let funcionariosParaExibir = [];
                    if (canViewAll) { 
                        funcionariosParaExibir = state.funcionarios || []; 
                    } else {
                        const funcionarioDoUsuario = (state.funcionarios || []).find(f => f.email && f.email.toLowerCase() === userEmail.toLowerCase());
                        if (funcionarioDoUsuario) {
                            funcionariosParaExibir = [funcionarioDoUsuario];
                            state.funcionarioSelecionadoId = funcionarioDoUsuario.id;
                        }
                    }
                    
                    if (funcionariosParaExibir.length === 0) {
                        const option = document.createElement('option');
                        option.textContent = canEdit ? "Adicione um funcionário" : "Nenhum planejamento atribuído";
                        employeeSelect.appendChild(option);
                        employeeSelect.disabled = true; 
                        removeEmployeeBtn.disabled = true;
                        makeSupervisorBtn.disabled = true;
                    } else {
                        employeeSelect.disabled = !canViewAll; 
                        removeEmployeeBtn.disabled = !canEdit;
                        makeSupervisorBtn.disabled = !canEdit;

                        funcionariosParaExibir.forEach(func => {
                            const option = document.createElement('option');
                            option.value = func.id;
                            option.textContent = func.nome;
                            employeeSelect.appendChild(option);
                        });
                        if (!funcionariosParaExibir.some(f => f.id === state.funcionarioSelecionadoId) && funcionariosParaExibir.length > 0) {
                             state.funcionarioSelecionadoId = funcionariosParaExibir[0].id;
                        }
                        employeeSelect.value = state.funcionarioSelecionadoId;
                    }
                    updateSupervisorStatusText();
                }

                function renderCalendar() {
                    calendarContainer.innerHTML = '';
                    const funcionarioAtual = state.funcionarios ? state.funcionarios.find(f => f.id === state.funcionarioSelecionadoId) : null;
                    MONTHS.forEach((monthName, monthIndex) => {
                        const monthContainer = document.createElement('div');
                        monthContainer.className = 'month-container';
                        const title = document.createElement('h3');
                        title.className = 'month-title';
                        title.textContent = monthName;
                        monthContainer.appendChild(title);
                        const monthGrid = document.createElement('div');
                        monthGrid.className = 'month-grid';
                        DAYS_OF_WEEK.forEach(day => {
                            const headerCell = document.createElement('div');
                            headerCell.className = 'header-cell';
                            headerCell.textContent = day;
                            monthGrid.appendChild(headerCell);
                        });
                        const daysInMonth = new Date(selectedYear, monthIndex + 1, 0).getDate();
                        const firstDayOfWeek = (new Date(selectedYear, monthIndex, 1).getDay() + 6) % 7;
                        for (let i = 0; i < firstDayOfWeek; i++) {
                            monthGrid.appendChild(document.createElement('div')).classList.add('day-cell', 'empty');
                        }
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dayCell = document.createElement('div');
                            dayCell.classList.add('day-cell', 'valid-day');
                            dayCell.textContent = day;
                            const dateString = `${selectedYear}-${String(monthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            dayCell.dataset.date = dateString;
                            const dayOfWeek = new Date(selectedYear, monthIndex, day).getDay();
                            if (dayOfWeek === 0 || dayOfWeek === 6) { dayCell.classList.add('weekend'); }

                            if (funcionarioAtual && funcionarioAtual.calendario && funcionarioAtual.calendario[dateString]) {
                                const entry = funcionarioAtual.calendario[dateString];
                                const data = typeof entry === 'string' ? { cor: entry } : entry;
                                if (data.cor && data.cor !== 'default') { dayCell.classList.add(`color-${data.cor}`); }
                                
                                const hasDetails = data.cor !== 'default' || (parseFloat(data.extras) || 0) > 0 || (parseFloat(data.atrasos) || 0) > 0 || data.extrasObs || data.atrasosObs;
                                if (hasDetails) {
                                    dayCell.classList.add('has-hours');
                                }
                            }
                            monthGrid.appendChild(dayCell);
                        }
                        monthContainer.appendChild(monthGrid);
                        calendarContainer.appendChild(monthContainer);
                    });
                }
                
                function handleDayClick(event) {
                    const cell = event.target.closest('.valid-day');
                    if (!cell || !state.funcionarioSelecionadoId) return;

                    if (isTouchDevice) {
                        toggleTooltipOnTap(cell);
                        return; 
                    }
                    
                    openEditModal(cell);
                }

                function openEditModal(cell) {
                    currentlyEditingDate = cell.dataset.date;
                    const funcionario = state.funcionarios.find(f => f.id === state.funcionarioSelecionadoId);
                    const entry = (funcionario?.calendario?.[currentlyEditingDate]) || {};
                    const data = typeof entry === 'string' ? { cor: entry } : entry;
                    
                    modalColorSelect.value = data.cor || 'default';
                    modalExtraHours.value = data.extras || '';
                    modalLateHours.value = data.atrasos || '';
                    modalExtraObs.value = data.extrasObs || '';
                    modalLateObs.value = data.atrasosObs || '';

                    const isReadOnly = !canEdit;
                    modalColorSelect.disabled = isReadOnly;
                    modalExtraHours.disabled = isReadOnly;
                    modalExtraObs.disabled = isReadOnly;
                    modalLateHours.disabled = isReadOnly;
                    modalLateObs.disabled = isReadOnly;

                    if (isReadOnly) {
                        modalTitle.textContent = `Detalhes do Dia - ${new Date(currentlyEditingDate + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                        modalSaveBtn.classList.add('hidden');
                        modalCancelBtn.textContent = 'Fechar';
                    } else {
                        modalTitle.textContent = `Editar Dia - ${new Date(currentlyEditingDate + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                        modalSaveBtn.classList.remove('hidden');
                        modalCancelBtn.textContent = 'Cancelar';
                    }
                    
                    modal.classList.remove('hidden');
                }

                function handleSaveDay() {
                    if (!currentlyEditingDate || !canEdit) return;
                    const funcionario = state.funcionarios.find(f => f.id === state.funcionarioSelecionadoId);
                    if (!funcionario) return;
                    if (!funcionario.calendario) { funcionario.calendario = {}; }

                    const newColor = modalColorSelect.value;
                    const newExtras = parseFloat(modalExtraHours.value) || 0;
                    const newAtrasos = parseFloat(modalLateHours.value) || 0;
                    const newExtrasObs = modalExtraObs.value.trim();
                    const newAtrasosObs = modalLateObs.value.trim();

                    if (newColor === 'default' && newExtras === 0 && newAtrasos === 0 && !newExtrasObs && !newAtrasosObs) {
                        delete funcionario.calendario[currentlyEditingDate];
                    } else {
                        funcionario.calendario[currentlyEditingDate] = { 
                            cor: newColor, 
                            extras: newExtras, 
                            atrasos: newAtrasos,
                            extrasObs: newExtrasObs,
                            atrasosObs: newAtrasosObs
                        };
                    }
                    
                    saveState();
                    modal.classList.add('hidden');
                    currentlyEditingDate = null;
                }
                
                function handleAddEmployee() {
                    if (!canEdit) return; 
                    const name = newEmployeeInput.value.trim();
                    const email = newEmployeeEmailInput.value.trim();
                    if (name) {
                        const newId = `func-${Date.now()}`;
                        if (!state.funcionarios) { state.funcionarios = []; }
                        state.funcionarios.push({ id: newId, nome: name, email: email || '', calendario: {} });
                        state.funcionarioSelecionadoId = newId;
                        newEmployeeInput.value = '';
                        newEmployeeEmailInput.value = '';
                        saveState();
                    } else { alert('Por favor, insira um nome para o funcionário.'); }
                }

                function handleRemoveEmployee() {
                    if (!canEdit || !state.funcionarioSelecionadoId || !state.funcionarios || state.funcionarios.length === 0) return;
                    const selectedEmployee = state.funcionarios.find(f => f.id === state.funcionarioSelecionadoId);
                    if(confirm(`Tem certeza que deseja remover "${selectedEmployee.nome}"? Esta ação não pode ser desfeita.`)) {
                        state.funcionarios = state.funcionarios.filter(f => f.id !== state.funcionarioSelecionadoId);
                        state.funcionarioSelecionadoId = state.funcionarios.length > 0 ? state.funcionarios[0].id : null;
                        saveState();
                    }
                }

                function handleSelectEmployee() {
                    state.funcionarioSelecionadoId = employeeSelect.value;
                    renderCalendar();
                    calculateAndDisplaySummaries();
                    updateSupervisorStatusText();
                }

                function handleYearChange() {
                    localStateLoaded = false;
                    calendarContainer.innerHTML = '<p style="text-align:center;">Carregando dados do novo ano...</p>';
                    employeeSelect.innerHTML = '';
                    listenForChanges();
                }
                
                function toggleTooltipOnTap(cell) {
                    if (activeTooltipCell === cell) {
                        hideTooltip();
                        activeTooltipCell = null;
                        return;
                    }
                    if (activeTooltipCell) {
                        hideTooltip();
                    }
                    showTooltip({ target: cell }); 
                    activeTooltipCell = cell;
                }

                function showTooltip(event) {
                    const dayCell = event.target.closest('.day-cell.has-hours');
                    if (!dayCell) return;

                    const dateStr = dayCell.dataset.date;
                    const funcionarioAtual = state.funcionarios.find(f => f.id === state.funcionarioSelecionadoId);
                    const dayData = funcionarioAtual?.calendario?.[dateStr];
                    if (!dayData) return;

                    const statusMap = { 'default': 'Normal', 'verde': 'Feriado Nacional', 'amarelo': 'Emenda', 'laranja': 'Feriado Estadual', 'vermelho': 'Falta', 'roxo': 'Afastado' };
                    
                    let content = `<h4>${new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: 'long'})}</h4>`;
                    content += `<p><span>Status:</span> <strong>${statusMap[dayData.cor]}</strong></p>`;
                    
                    if (dayData.extras > 0) {
                        content += `<p><span>Horas Extras:</span> <strong>${dayData.extras}h</strong></p>`;
                        if (dayData.extrasObs) {
                            content += `<div class="obs">${dayData.extrasObs}</div>`;
                        }
                    }
                    if (dayData.atrasos > 0) {
                        content += `<p><span>Atraso:</span> <strong>${dayData.atrasos}h</strong></p>`;
                        if (dayData.atrasosObs) {
                            content += `<div class="obs">${dayData.atrasosObs}</div>`;
                        }
                    }
                    
                    tooltip.innerHTML = content;
                    tooltip.classList.remove('hidden');

                    const rect = dayCell.getBoundingClientRect();
                    const tooltipWidth = tooltip.offsetWidth;
                    const tooltipHeight = tooltip.offsetHeight;

                    let top = window.scrollY + rect.top - tooltipHeight - 10;
                    if (top < window.scrollY + 10) {
                        top = window.scrollY + rect.bottom + 10;
                    }

                    let left = window.scrollX + rect.left + (rect.width / 2) - (tooltipWidth / 2);
                    
                    const margin = 10;
                    if (left < window.scrollX + margin) {
                        left = window.scrollX + margin;
                    }
                    if ((left + tooltipWidth) > (window.scrollX + window.innerWidth - margin)) {
                        left = window.scrollX + window.innerWidth - tooltipWidth - margin;
                    }

                    tooltip.style.left = `${left}px`;
                    tooltip.style.top = `${top}px`;
                }

                function hideTooltip() {
                    tooltip.classList.add('hidden');
                }
                
                // NOVA FUNÇÃO PARA GERENCIAR SUPERVISORES
                function handleMakeSupervisor() {
                    if (!canEdit || !state.funcionarioSelecionadoId) return;

                    const funcionario = state.funcionarios.find(f => f.id === state.funcionarioSelecionadoId);
                    if (!funcionario || !funcionario.email) {
                        alert("Este funcionário não tem um e-mail de login associado e não pode ser tornado supervisor.");
                        return;
                    }
                    
                    // Devido a limitações de segurança do Firebase SDK no cliente, não é possível buscar
                    // o UID de um usuário a partir do e-mail. A solução correta envolve uma Cloud Function.
                    // Como alternativa, instruímos o administrador a fazer a alteração manualmente.
                    const instructions = `Para alterar a função de "${funcionario.nome}" (${funcionario.email}):\n\n` +
                                         `1. Vá para o seu console do Firebase e abra o Firestore Database.\n` +
                                         `2. Encontre a coleção "user_roles".\n` +
                                         `3. Você precisa do UID (ID do Usuário) deste e-mail. Você pode encontrá-lo na seção "Authentication" do Firebase.\n` +
                                         `4. No Firestore, encontre o documento com o nome desse UID.\n` +
                                         `5. Para torná-lo SUPERVISOR, mude o campo "role" para "supervisor".\n` +
                                         `6. Para REMOVER o acesso de supervisor, mude o campo "role" para "viewer".\n\n` +
                                         `Esta alteração manual é necessária por segurança.`;
                    
                    alert(instructions);
                }

                // NOVA FUNÇÃO para atualizar o texto de status
                function updateSupervisorStatusText() {
                    employeeStatusSpan.textContent = ''; // Limpa o status
                    const funcionario = state.funcionarios.find(f => f.id === state.funcionarioSelecionadoId);

                    // Esta função não pode verificar o status real no Firestore sem o UID.
                    // Ela serve como um lembrete visual de que a funcionalidade existe.
                    if (canEdit && funcionario && funcionario.email) {
                        employeeStatusSpan.textContent = '(Clique em "Tornar/Remover Supervisor" para gerenciar o acesso)';
                    }
                }
                
                populateHoursDatalist();
                listenForChanges();
                
                changePasswordBtn.addEventListener('click', () => {
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    passwordChangeError.textContent = '';
                    changePasswordModal.classList.remove('hidden');
                });

                passwordCancelBtn.addEventListener('click', () => {
                    changePasswordModal.classList.add('hidden');
                });

                passwordSaveBtn.addEventListener('click', () => {
                    const newPassword = newPasswordInput.value;
                    const confirmPassword = confirmPasswordInput.value;
                    passwordChangeError.textContent = '';

                    if (newPassword.length < 6) {
                        passwordChangeError.textContent = 'A senha deve ter no mínimo 6 caracteres.';
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        passwordChangeError.textContent = 'As senhas não conferem.';
                        return;
                    }

                    const user = firebase.auth().currentUser;
                    if (user) {
                        passwordSaveBtn.disabled = true;
                        passwordChangeError.textContent = 'Alterando...';
                        user.updatePassword(newPassword).then(() => {
                            changePasswordModal.classList.add('hidden');
                            alert('Senha alterada com sucesso!');
                            passwordSaveBtn.disabled = false;
                        }).catch((error) => {
                            console.error("Erro ao alterar a senha:", error);
                            passwordChangeError.textContent = 'Erro: Tente sair e logar novamente.';
                            passwordSaveBtn.disabled = false;
                        });
                    }
                });

                // --- Event Listeners ATUALIZADOS ---
                calendarContainer.addEventListener('click', handleDayClick);

                if (!isTouchDevice) {
                    calendarContainer.addEventListener('mouseover', showTooltip);
                    calendarContainer.addEventListener('mouseout', hideTooltip);
                } else {
                    document.addEventListener('click', (event) => {
                        if (activeTooltipCell && !calendarContainer.contains(event.target)) {
                            hideTooltip();
                            activeTooltipCell = null;
                        }
                    });
                }

                addEmployeeBtn.addEventListener('click', handleAddEmployee);
                removeEmployeeBtn.addEventListener('click', handleRemoveEmployee);
                employeeSelect.addEventListener('change', handleSelectEmployee);
                yearSelect.addEventListener('change', handleYearChange);
                modalSaveBtn.addEventListener('click', handleSaveDay);
                modalCancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
                makeSupervisorBtn.addEventListener('click', handleMakeSupervisor);
            }
        });
    </script>
</body>
</html>
